<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript">
            window.onload = function(){
                var connection = new WebSocket("ws://localhost:8766/");
                console.log("start");
                connection.onopen = function(){
                    connection.send("pls send me data");
                };

                connection.onmessage = function(event){
                    var received_data = event.data || Window.event.data;
                    draw(received_data);
                    connection.close();
                };

                connection.onclose = function(event){
                    console.log("websocket close");
                };

                connection.onerror = function(event){
                    console.error("Websocket error observed:", event);
                };
            }
        </script>
    </head>
    <body>
        <canvas id = "defectmap" width = "1000" height = "1000"></canvas>
        <script>
                function draw(mydata){
                    raw_data = JSON.parse(mydata);
                    for(var item in raw_data){
                        // sampling_coord = JSON.parse(raw_data['sampling_coord']);
                        // sampling_edge = JSON.parse(raw_data['sampling_edge']);
                        sampling_coord = JSON.parse(raw_data['sampling_coor']);
                        sampling_edge = raw_data['sampling_edge'];
                    }

                    canvas = document.getElementById("defectmap");
                    var map = canvas.getContext("2d");

                    // map.beginPath();
                    // map.arc(200, 200, 200, -Math.PI, Math.PI, false);
                    // map.closePath();
                    // map.stroke();

                    map.translate(100, 100);
                    map.lineWidth = 0.1;

                    for (var item in Object.values(sampling_coord)){
                        // console.log(typeof(sampling_coord[item]));
                        var index_defy = parseInt(sampling_edge['def_yl'])+1  - parseInt(sampling_coord[item]['y']);
                        var index_defx = Math.abs(parseInt(sampling_edge['def_xl']))+1  + parseInt(sampling_coord[item]['x']);
                        x_pixel = 2490/352.73;
                        y_pixel = 2260/352.73;
                        map.strokeRect(index_defx * x_pixel, index_defy * y_pixel, x_pixel, y_pixel);
                        map.save();
                        map.translate(index_defx * x_pixel, index_defy * y_pixel - y_pixel * 2);
                        console.log(index_defx * x_pixel);
                        console.log(index_defy * y_pixel - y_pixel * 2);
                        // x size = 9.440000 um 0.03
                        // y size = 7.280000 um 0.02
                        // XREL = 1.7531200000e+03  4.96 pixel
                        // YREL = 5.0608000000e+02  1.434 pixel
                        map.strokeRect(4.96, 1.43, 0.03, 0.02);
                        map.restore();
                    }
                }
        </script>
    </body>
</html>